diff --git a/.idea/workspace.xml b/.idea/workspace.xml
index 6ef8ba2..3feb869 100644
--- a/.idea/workspace.xml
+++ b/.idea/workspace.xml
@@ -3,11 +3,10 @@
   <component name="ChangeListManager">
     <list default="true" id="06c02438-23c6-41ad-92d4-52eeb54a8331" name="Default" comment="">
       <change beforePath="$PROJECT_DIR$/.idea/workspace.xml" afterPath="$PROJECT_DIR$/.idea/workspace.xml" />
-      <change beforePath="$PROJECT_DIR$/test.py" afterPath="$PROJECT_DIR$/test.py" />
-      <change beforePath="$PROJECT_DIR$/train.py" afterPath="$PROJECT_DIR$/train.py" />
+      <change beforePath="$PROJECT_DIR$/darknet_flags.py" afterPath="$PROJECT_DIR$/darknet_flags.py" />
+      <change beforePath="$PROJECT_DIR$/dornet_utils.py" afterPath="$PROJECT_DIR$/dornet_utils.py" />
+      <change beforePath="$PROJECT_DIR$/run_this.sh" afterPath="$PROJECT_DIR$/run_this.sh" />
       <change beforePath="$PROJECT_DIR$/train_decision.py" afterPath="$PROJECT_DIR$/train_decision.py" />
-      <change beforePath="$PROJECT_DIR$/yolo3/model.py" afterPath="$PROJECT_DIR$/yolo3/model.py" />
-      <change beforePath="$PROJECT_DIR$/yolo3/utils.py" afterPath="$PROJECT_DIR$/yolo3/utils.py" />
     </list>
     <option name="EXCLUDED_CONVERTED_TO_IGNORED" value="true" />
     <option name="TRACKING_ENABLED" value="true" />
@@ -19,21 +18,21 @@
   <component name="CoverageDataManager">
     <SUITE FILE_PATH="coverage/keras_yolo3$xinli.coverage" NAME="xinli Coverage Results" MODIFIED="1548139182434" SOURCE_PROVIDER="com.intellij.coverage.DefaultCoverageFileProvider" RUNNER="coverage.py" COVERAGE_BY_TEST_ENABLED="true" COVERAGE_TRACING_ENABLED="false" WORKING_DIRECTORY="$PROJECT_DIR$/../../../tmp" />
     <SUITE FILE_PATH="coverage/keras_yolo3$train_py.coverage" NAME="train.py Coverage Results" MODIFIED="1550818964362" SOURCE_PROVIDER="com.intellij.coverage.DefaultCoverageFileProvider" RUNNER="coverage.py" COVERAGE_BY_TEST_ENABLED="true" COVERAGE_TRACING_ENABLED="false" WORKING_DIRECTORY="$PROJECT_DIR$" />
-    <SUITE FILE_PATH="coverage/keras_yolo3$test.coverage" NAME="train_decision.py Coverage Results" MODIFIED="1550819858182" SOURCE_PROVIDER="com.intellij.coverage.DefaultCoverageFileProvider" RUNNER="coverage.py" COVERAGE_BY_TEST_ENABLED="true" COVERAGE_TRACING_ENABLED="false" WORKING_DIRECTORY="$PROJECT_DIR$" />
+    <SUITE FILE_PATH="coverage/keras_yolo3$test.coverage" NAME="train_decision.py Coverage Results" MODIFIED="1550846161730" SOURCE_PROVIDER="com.intellij.coverage.DefaultCoverageFileProvider" RUNNER="coverage.py" COVERAGE_BY_TEST_ENABLED="true" COVERAGE_TRACING_ENABLED="false" WORKING_DIRECTORY="$PROJECT_DIR$" />
     <SUITE FILE_PATH="coverage/keras_yolo3$draw_two_line.coverage" NAME="draw_two_line Coverage Results" MODIFIED="1550127175890" SOURCE_PROVIDER="com.intellij.coverage.DefaultCoverageFileProvider" RUNNER="coverage.py" COVERAGE_BY_TEST_ENABLED="true" COVERAGE_TRACING_ENABLED="false" WORKING_DIRECTORY="$PROJECT_DIR$/../darknet/backup/turtlebot_12.12/log" />
   </component>
   <component name="FavoritesManager">
     <favorites_list name="keras-yolo3" />
   </component>
   <component name="FileEditorManager">
-    <splitter split-orientation="horizontal" split-proportion="0.43145654">
+    <splitter split-orientation="horizontal" split-proportion="0.50244796">
       <split-first>
         <leaf SIDE_TABS_SIZE_LIMIT_KEY="300">
-          <file leaf-file-name="train_decision.py" pinned="false" current-in-tab="true">
+          <file leaf-file-name="train_decision.py" pinned="false" current-in-tab="false">
             <entry file="file://$PROJECT_DIR$/train_decision.py">
               <provider selected="true" editor-type-id="text-editor">
-                <state relative-caret-position="195">
-                  <caret line="246" column="4" lean-forward="false" selection-start-line="246" selection-start-column="4" selection-end-line="246" selection-end-column="4" />
+                <state relative-caret-position="267">
+                  <caret line="58" column="43" lean-forward="false" selection-start-line="58" selection-start-column="43" selection-end-line="58" selection-end-column="43" />
                   <folding>
                     <element signature="e#92#101#0" expanded="true" />
                   </folding>
@@ -41,33 +40,41 @@
               </provider>
             </entry>
           </file>
-          <file leaf-file-name="darknet_flags.py" pinned="false" current-in-tab="false">
-            <entry file="file://$PROJECT_DIR$/darknet_flags.py">
+          <file leaf-file-name="utils.py" pinned="false" current-in-tab="false">
+            <entry file="file://$PROJECT_DIR$/yolo3/utils.py">
               <provider selected="true" editor-type-id="text-editor">
-                <state relative-caret-position="297">
-                  <caret line="17" column="33" lean-forward="false" selection-start-line="17" selection-start-column="23" selection-end-line="17" selection-end-column="33" />
+                <state relative-caret-position="18">
+                  <caret line="131" column="24" lean-forward="false" selection-start-line="131" selection-start-column="24" selection-end-line="131" selection-end-column="24" />
                   <folding />
                 </state>
               </provider>
             </entry>
           </file>
-          <file leaf-file-name="model.py" pinned="false" current-in-tab="false">
-            <entry file="file://$PROJECT_DIR$/yolo3/model.py">
+          <file leaf-file-name="run_this.sh" pinned="false" current-in-tab="false">
+            <entry file="file://$PROJECT_DIR$/run_this.sh">
               <provider selected="true" editor-type-id="text-editor">
-                <state relative-caret-position="195">
-                  <caret line="415" column="4" lean-forward="false" selection-start-line="415" selection-start-column="4" selection-end-line="415" selection-end-column="4" />
-                  <folding>
-                    <element signature="e#77#104#0" expanded="true" />
-                  </folding>
+                <state relative-caret-position="324">
+                  <caret line="18" column="29" lean-forward="false" selection-start-line="18" selection-start-column="29" selection-end-line="18" selection-end-column="29" />
+                  <folding />
                 </state>
               </provider>
             </entry>
           </file>
-          <file leaf-file-name="core.py" pinned="false" current-in-tab="false">
-            <entry file="file:///usr/local/lib/python3.5/dist-packages/keras/layers/core.py">
+          <file leaf-file-name="train.py" pinned="false" current-in-tab="false">
+            <entry file="file://$PROJECT_DIR$/train.py">
               <provider selected="true" editor-type-id="text-editor">
-                <state relative-caret-position="195">
-                  <caret line="600" column="8" lean-forward="false" selection-start-line="600" selection-start-column="8" selection-end-line="600" selection-end-column="8" />
+                <state relative-caret-position="325">
+                  <caret line="67" column="18" lean-forward="false" selection-start-line="67" selection-start-column="18" selection-end-line="67" selection-end-column="18" />
+                  <folding />
+                </state>
+              </provider>
+            </entry>
+          </file>
+          <file leaf-file-name="darknet_flags.py" pinned="false" current-in-tab="true">
+            <entry file="file://$PROJECT_DIR$/darknet_flags.py">
+              <provider selected="true" editor-type-id="text-editor">
+                <state relative-caret-position="213">
+                  <caret line="20" column="40" lean-forward="false" selection-start-line="20" selection-start-column="40" selection-end-line="20" selection-end-column="40" />
                   <folding />
                 </state>
               </provider>
@@ -77,11 +84,11 @@
       </split-first>
       <split-second>
         <leaf>
-          <file leaf-file-name="train_decision.py" pinned="false" current-in-tab="false">
+          <file leaf-file-name="train_decision.py" pinned="false" current-in-tab="true">
             <entry file="file://$PROJECT_DIR$/train_decision.py">
               <provider selected="true" editor-type-id="text-editor">
-                <state relative-caret-position="387">
-                  <caret line="306" column="0" lean-forward="false" selection-start-line="306" selection-start-column="0" selection-end-line="306" selection-end-column="0" />
+                <state relative-caret-position="195">
+                  <caret line="114" column="28" lean-forward="false" selection-start-line="113" selection-start-column="26" selection-end-line="114" selection-end-column="28" />
                   <folding>
                     <element signature="e#92#101#0" expanded="true" />
                   </folding>
@@ -89,11 +96,23 @@
               </provider>
             </entry>
           </file>
+          <file leaf-file-name="dronet_log_utils.py" pinned="false" current-in-tab="false">
+            <entry file="file://$PROJECT_DIR$/dronet_log_utils.py">
+              <provider selected="true" editor-type-id="text-editor">
+                <state relative-caret-position="221">
+                  <caret line="40" column="20" lean-forward="false" selection-start-line="40" selection-start-column="20" selection-end-line="40" selection-end-column="20" />
+                  <folding>
+                    <element signature="e#0#18#0" expanded="true" />
+                  </folding>
+                </state>
+              </provider>
+            </entry>
+          </file>
           <file leaf-file-name="model.py" pinned="false" current-in-tab="false">
             <entry file="file://$PROJECT_DIR$/yolo3/model.py">
               <provider selected="true" editor-type-id="text-editor">
-                <state relative-caret-position="253">
-                  <caret line="415" column="8" lean-forward="false" selection-start-line="415" selection-start-column="8" selection-end-line="415" selection-end-column="8" />
+                <state relative-caret-position="-399">
+                  <caret line="127" column="4" lean-forward="false" selection-start-line="127" selection-start-column="4" selection-end-line="127" selection-end-column="4" />
                   <folding>
                     <element signature="e#77#104#0" expanded="true" />
                   </folding>
@@ -104,8 +123,8 @@
           <file leaf-file-name="dornet_utils.py" pinned="false" current-in-tab="false">
             <entry file="file://$PROJECT_DIR$/dornet_utils.py">
               <provider selected="true" editor-type-id="text-editor">
-                <state relative-caret-position="-1391">
-                  <caret line="460" column="8" lean-forward="false" selection-start-line="460" selection-start-column="8" selection-end-line="460" selection-end-column="8" />
+                <state relative-caret-position="113">
+                  <caret line="422" column="10" lean-forward="false" selection-start-line="422" selection-start-column="10" selection-end-line="422" selection-end-column="10" />
                   <folding>
                     <element signature="e#38#47#0" expanded="true" />
                   </folding>
@@ -113,16 +132,6 @@
               </provider>
             </entry>
           </file>
-          <file leaf-file-name="train.py" pinned="false" current-in-tab="true">
-            <entry file="file://$PROJECT_DIR$/train.py">
-              <provider selected="true" editor-type-id="text-editor">
-                <state relative-caret-position="-399">
-                  <caret line="143" column="24" lean-forward="false" selection-start-line="143" selection-start-column="24" selection-end-line="143" selection-end-column="24" />
-                  <folding />
-                </state>
-              </provider>
-            </entry>
-          </file>
         </leaf>
       </split-second>
     </splitter>
@@ -136,22 +145,6 @@
   </component>
   <component name="FindInProjectRecents">
     <findStrings>
-      <find>data_generator</find>
-      <find>model</find>
-      <find>num_classes</find>
-      <find>log_dir</find>
-      <find>train_dir</find>
-      <find>restore_model</find>
-      <find>epoch</find>
-      <find>FLAGS</find>
-      <find>load</find>
-      <find>follow_links</find>
-      <find>annotation_line</find>
-      <find>line</find>
-      <find>reduce_lr</find>
-      <find>exp_type</find>
-      <find>samples</find>
-      <find>batch</find>
       <find>batch_steer</find>
       <find>anchor_mask</find>
       <find>args</find>
@@ -162,10 +155,26 @@
       <find>batch_size</find>
       <find>FLAGS.batch_size</find>
       <find>yolo_default_label</find>
-      <find>img_mode</find>
       <find>model_loss</find>
       <find>y_true</find>
+      <find>checkpoint</find>
+      <find>rate</find>
+      <find>lr</find>
       <find>y_pred</find>
+      <find>k_entropy</find>
+      <find>reduce_lr</find>
+      <find>time</find>
+      <find>ETA</find>
+      <find>loss_weights_list</find>
+      <find>weight_l</find>
+      <find>weighted_loss</find>
+      <find>compile</find>
+      <find>log_rate</find>
+      <find>loss_weights</find>
+      <find>experiment_rootdir</find>
+      <find>weights_path</find>
+      <find>alpha</find>
+      <find>img_mode</find>
     </findStrings>
   </component>
   <component name="Git.Settings">
@@ -177,16 +186,18 @@
         <option value="$PROJECT_DIR$/convert.py" />
         <option value="$PROJECT_DIR$/yolo.py" />
         <option value="$PROJECT_DIR$/yolo3/test.py" />
-        <option value="$PROJECT_DIR$/run_this.sh" />
         <option value="$PROJECT_DIR$/../../../tmp/xinli.py" />
         <option value="$PROJECT_DIR$/../darknet/backup/turtlebot_12.12/log/draw_two_line.py" />
         <option value="$PROJECT_DIR$/test.py" />
         <option value="$PROJECT_DIR$/yolo3/utils.py" />
+        <option value="$PROJECT_DIR$/dronet_logz.py" />
+        <option value="$PROJECT_DIR$/dronet_log_utils.py" />
         <option value="$PROJECT_DIR$/train.py" />
-        <option value="$PROJECT_DIR$/dornet_utils.py" />
-        <option value="$PROJECT_DIR$/darknet_flags.py" />
+        <option value="$PROJECT_DIR$/run_this.sh" />
         <option value="$PROJECT_DIR$/yolo3/model.py" />
+        <option value="$PROJECT_DIR$/dornet_utils.py" />
         <option value="$PROJECT_DIR$/train_decision.py" />
+        <option value="$PROJECT_DIR$/darknet_flags.py" />
       </list>
     </option>
   </component>
@@ -411,13 +422,14 @@
     <layout>
       <window_info id="TODO" active="false" anchor="bottom" auto_hide="false" internal_type="DOCKED" type="DOCKED" visible="false" show_stripe_button="true" weight="0.33" sideWeight="0.5" order="11" side_tool="false" content_ui="tabs" />
       <window_info id="Event Log" active="false" anchor="bottom" auto_hide="false" internal_type="DOCKED" type="DOCKED" visible="false" show_stripe_button="true" weight="0.33" sideWeight="0.5" order="0" side_tool="true" content_ui="tabs" />
-      <window_info id="Run" active="false" anchor="bottom" auto_hide="false" internal_type="DOCKED" type="DOCKED" visible="true" show_stripe_button="true" weight="0.32948583" sideWeight="0.5" order="10" side_tool="false" content_ui="tabs" />
+      <window_info id="Run" active="true" anchor="bottom" auto_hide="false" internal_type="DOCKED" type="DOCKED" visible="true" show_stripe_button="true" weight="0.32948583" sideWeight="0.5" order="10" side_tool="false" content_ui="tabs" />
       <window_info id="Version Control" active="false" anchor="bottom" auto_hide="false" internal_type="DOCKED" type="DOCKED" visible="false" show_stripe_button="true" weight="0.33" sideWeight="0.5" order="1" side_tool="false" content_ui="tabs" />
       <window_info id="Python Console" active="false" anchor="bottom" auto_hide="false" internal_type="DOCKED" type="DOCKED" visible="false" show_stripe_button="true" weight="0.33" sideWeight="0.5" order="2" side_tool="false" content_ui="tabs" />
       <window_info id="Terminal" active="false" anchor="bottom" auto_hide="false" internal_type="DOCKED" type="DOCKED" visible="false" show_stripe_button="true" weight="0.33" sideWeight="0.5" order="3" side_tool="false" content_ui="tabs" />
       <window_info id="Project" active="false" anchor="left" auto_hide="false" internal_type="DOCKED" type="DOCKED" visible="true" show_stripe_button="true" weight="0.119137466" sideWeight="0.4963274" order="1" side_tool="false" content_ui="combo" />
       <window_info id="Docker" active="false" anchor="bottom" auto_hide="false" internal_type="DOCKED" type="DOCKED" visible="false" show_stripe_button="false" weight="0.33" sideWeight="0.5" order="4" side_tool="false" content_ui="tabs" />
       <window_info id="Database" active="false" anchor="right" auto_hide="false" internal_type="DOCKED" type="DOCKED" visible="false" show_stripe_button="true" weight="0.33" sideWeight="0.5" order="0" side_tool="false" content_ui="tabs" />
+      <window_info id="Find" active="false" anchor="bottom" auto_hide="false" internal_type="DOCKED" type="DOCKED" visible="false" show_stripe_button="true" weight="0.33" sideWeight="0.5" order="6" side_tool="false" content_ui="tabs" />
       <window_info id="SciView" active="false" anchor="right" auto_hide="false" internal_type="DOCKED" type="DOCKED" visible="false" show_stripe_button="true" weight="0.5148248" sideWeight="0.5" order="1" side_tool="false" content_ui="tabs" />
       <window_info id="Structure" active="false" anchor="left" auto_hide="false" internal_type="DOCKED" type="DOCKED" visible="false" show_stripe_button="true" weight="0.25" sideWeight="0.5" order="2" side_tool="false" content_ui="tabs" />
       <window_info id="Debug" active="false" anchor="bottom" auto_hide="false" internal_type="DOCKED" type="DOCKED" visible="false" show_stripe_button="true" weight="0.31689402" sideWeight="0.5" order="7" side_tool="false" content_ui="tabs" />
@@ -427,7 +439,6 @@
       <window_info id="Commander" active="false" anchor="right" auto_hide="false" internal_type="DOCKED" type="DOCKED" visible="false" show_stripe_button="true" weight="0.4" sideWeight="0.5" order="2" side_tool="false" content_ui="tabs" />
       <window_info id="Inspection" active="false" anchor="bottom" auto_hide="false" internal_type="DOCKED" type="DOCKED" visible="false" show_stripe_button="true" weight="0.4" sideWeight="0.5" order="9" side_tool="false" content_ui="tabs" />
       <window_info id="Hierarchy" active="false" anchor="right" auto_hide="false" internal_type="DOCKED" type="DOCKED" visible="false" show_stripe_button="true" weight="0.25" sideWeight="0.5" order="4" side_tool="false" content_ui="combo" />
-      <window_info id="Find" active="false" anchor="bottom" auto_hide="false" internal_type="DOCKED" type="DOCKED" visible="false" show_stripe_button="true" weight="0.33" sideWeight="0.5" order="6" side_tool="false" content_ui="tabs" />
       <window_info id="Ant Build" active="false" anchor="right" auto_hide="false" internal_type="DOCKED" type="DOCKED" visible="false" show_stripe_button="true" weight="0.25" sideWeight="0.5" order="3" side_tool="false" content_ui="tabs" />
     </layout>
   </component>
@@ -446,7 +457,7 @@
         </line-breakpoint>
         <line-breakpoint enabled="true" suspend="THREAD" type="python-line">
           <url>file://$PROJECT_DIR$/train_decision.py</url>
-          <line>314</line>
+          <line>335</line>
           <option name="timeStamp" value="34" />
         </line-breakpoint>
         <line-breakpoint enabled="true" suspend="THREAD" type="python-line">
@@ -461,7 +472,7 @@
         </line-breakpoint>
         <line-breakpoint enabled="true" suspend="THREAD" type="python-line">
           <url>file://$PROJECT_DIR$/train_decision.py</url>
-          <line>250</line>
+          <line>271</line>
           <option name="timeStamp" value="46" />
         </line-breakpoint>
       </breakpoints>
@@ -472,7 +483,7 @@
           </properties>
         </breakpoint>
       </default-breakpoints>
-      <option name="time" value="47" />
+      <option name="time" value="48" />
     </breakpoint-manager>
     <watches-manager>
       <configuration name="PythonConfigurationType">
@@ -549,25 +560,11 @@
     </expressions>
   </component>
   <component name="editorHistoryManager">
-    <entry file="file:///usr/local/lib/python3.5/dist-packages/tensorflow/python/client/session.py">
-      <provider selected="true" editor-type-id="text-editor">
-        <state relative-caret-position="13806">
-          <caret line="786" column="6" lean-forward="false" selection-start-line="786" selection-start-column="6" selection-end-line="786" selection-end-column="6" />
-        </state>
-      </provider>
-    </entry>
-    <entry file="file:///usr/local/lib/python3.5/dist-packages/tensorflow/python/ops/variables.py">
-      <provider selected="true" editor-type-id="text-editor">
-        <state relative-caret-position="23418">
-          <caret line="1317" column="4" lean-forward="false" selection-start-line="1317" selection-start-column="4" selection-end-line="1317" selection-end-column="4" />
-          <folding />
-        </state>
-      </provider>
-    </entry>
     <entry file="file://$PROJECT_DIR$/run_this.sh">
       <provider selected="true" editor-type-id="text-editor">
         <state relative-caret-position="126">
           <caret line="7" column="0" lean-forward="true" selection-start-line="7" selection-start-column="0" selection-end-line="7" selection-end-column="0" />
+          <folding />
         </state>
       </provider>
     </entry>
@@ -630,13 +627,6 @@
         </state>
       </provider>
     </entry>
-    <entry file="file://$PROJECT_DIR$/run_this.sh">
-      <provider selected="true" editor-type-id="text-editor">
-        <state relative-caret-position="0">
-          <caret line="0" column="19" lean-forward="false" selection-start-line="0" selection-start-column="19" selection-end-line="0" selection-end-column="19" />
-        </state>
-      </provider>
-    </entry>
     <entry file="file://$PROJECT_DIR$/yolov3-tiny.cfg">
       <provider selected="true" editor-type-id="text-editor">
         <state relative-caret-position="0">
@@ -790,22 +780,6 @@
         </state>
       </provider>
     </entry>
-    <entry file="file:///usr/local/lib/python3.5/dist-packages/keras/backend/tensorflow_backend.py">
-      <provider selected="true" editor-type-id="text-editor">
-        <state relative-caret-position="235">
-          <caret line="1860" column="4" lean-forward="false" selection-start-line="1860" selection-start-column="4" selection-end-line="1860" selection-end-column="4" />
-          <folding />
-        </state>
-      </provider>
-    </entry>
-    <entry file="file:///usr/local/lib/python3.5/dist-packages/keras/callbacks.py">
-      <provider selected="true" editor-type-id="text-editor">
-        <state relative-caret-position="460">
-          <caret line="392" column="8" lean-forward="false" selection-start-line="392" selection-start-column="8" selection-end-line="392" selection-end-column="8" />
-          <folding />
-        </state>
-      </provider>
-    </entry>
     <entry file="file://$PROJECT_DIR$/utils.py">
       <provider selected="true" editor-type-id="text-editor">
         <state relative-caret-position="198">
@@ -864,16 +838,6 @@
         </state>
       </provider>
     </entry>
-    <entry file="file://$PROJECT_DIR$/yolo3/utils.py">
-      <provider selected="true" editor-type-id="text-editor">
-        <state relative-caret-position="-315">
-          <caret line="131" column="24" lean-forward="false" selection-start-line="131" selection-start-column="24" selection-end-line="131" selection-end-column="24" />
-          <folding>
-            <element signature="e#78#109#0" expanded="false" />
-          </folding>
-        </state>
-      </provider>
-    </entry>
     <entry file="file:///usr/local/lib/python3.5/dist-packages/tensorflow/python/keras/_impl/keras/preprocessing/image.py">
       <provider selected="true" editor-type-id="text-editor">
         <state relative-caret-position="199">
@@ -890,75 +854,127 @@
         </state>
       </provider>
     </entry>
-    <entry file="file://$PROJECT_DIR$/darknet_flags.py">
+    <entry file="file:///usr/local/lib/python3.5/dist-packages/keras/layers/core.py">
       <provider selected="true" editor-type-id="text-editor">
-        <state relative-caret-position="297">
-          <caret line="17" column="33" lean-forward="false" selection-start-line="17" selection-start-column="23" selection-end-line="17" selection-end-column="33" />
+        <state relative-caret-position="195">
+          <caret line="600" column="8" lean-forward="false" selection-start-line="600" selection-start-column="8" selection-end-line="600" selection-end-column="8" />
+          <folding />
+        </state>
+      </provider>
+    </entry>
+    <entry file="file://$PROJECT_DIR$/dronet_logz.py">
+      <provider selected="true" editor-type-id="text-editor">
+        <state relative-caret-position="378">
+          <caret line="21" column="0" lean-forward="true" selection-start-line="21" selection-start-column="0" selection-end-line="21" selection-end-column="0" />
+          <folding />
+        </state>
+      </provider>
+    </entry>
+    <entry file="file://$PROJECT_DIR$/run_this.sh">
+      <provider selected="true" editor-type-id="text-editor">
+        <state relative-caret-position="324">
+          <caret line="18" column="29" lean-forward="false" selection-start-line="18" selection-start-column="29" selection-end-line="18" selection-end-column="29" />
+          <folding />
+        </state>
+      </provider>
+    </entry>
+    <entry file="file:///usr/local/lib/python3.5/dist-packages/keras/backend/tensorflow_backend.py">
+      <provider selected="true" editor-type-id="text-editor">
+        <state relative-caret-position="-498">
+          <caret line="148" column="4" lean-forward="false" selection-start-line="148" selection-start-column="4" selection-end-line="148" selection-end-column="4" />
+          <folding />
+        </state>
+      </provider>
+    </entry>
+    <entry file="file:///usr/local/lib/python3.5/dist-packages/keras/callbacks.py">
+      <provider selected="true" editor-type-id="text-editor">
+        <state relative-caret-position="-291">
+          <caret line="392" column="8" lean-forward="false" selection-start-line="392" selection-start-column="8" selection-end-line="392" selection-end-column="8" />
           <folding />
         </state>
       </provider>
     </entry>
     <entry file="file:///usr/local/lib/python3.5/dist-packages/keras/engine/topology.py">
       <provider selected="true" editor-type-id="text-editor">
-        <state relative-caret-position="18">
-          <caret line="1466" column="6" lean-forward="false" selection-start-line="1466" selection-start-column="6" selection-end-line="1466" selection-end-column="6" />
+        <state relative-caret-position="-85">
+          <caret line="1922" column="8" lean-forward="false" selection-start-line="1922" selection-start-column="8" selection-end-line="1922" selection-end-column="8" />
           <folding />
         </state>
       </provider>
     </entry>
-    <entry file="file:///usr/local/lib/python3.5/dist-packages/keras/engine/training.py">
+    <entry file="file://$PROJECT_DIR$/dronet_log_utils.py">
       <provider selected="true" editor-type-id="text-editor">
-        <state relative-caret-position="87">
-          <caret line="544" column="15" lean-forward="false" selection-start-line="544" selection-start-column="15" selection-end-line="544" selection-end-column="15" />
+        <state relative-caret-position="221">
+          <caret line="40" column="20" lean-forward="false" selection-start-line="40" selection-start-column="20" selection-end-line="40" selection-end-column="20" />
+          <folding>
+            <element signature="e#0#18#0" expanded="true" />
+          </folding>
+        </state>
+      </provider>
+    </entry>
+    <entry file="file://$PROJECT_DIR$/train.py">
+      <provider selected="true" editor-type-id="text-editor">
+        <state relative-caret-position="325">
+          <caret line="67" column="18" lean-forward="false" selection-start-line="67" selection-start-column="18" selection-end-line="67" selection-end-column="18" />
           <folding />
         </state>
       </provider>
     </entry>
-    <entry file="file://$PROJECT_DIR$/dornet_utils.py">
+    <entry file="file:///usr/local/lib/python3.5/dist-packages/keras/engine/training.py">
       <provider selected="true" editor-type-id="text-editor">
-        <state relative-caret-position="-1391">
-          <caret line="460" column="8" lean-forward="false" selection-start-line="460" selection-start-column="8" selection-end-line="460" selection-end-column="8" />
+        <state relative-caret-position="-1957">
+          <caret line="818" column="43" lean-forward="false" selection-start-line="818" selection-start-column="36" selection-end-line="818" selection-end-column="43" />
           <folding>
-            <element signature="e#38#47#0" expanded="true" />
+            <element signature="e#74#112#0" expanded="false" />
           </folding>
         </state>
       </provider>
     </entry>
-    <entry file="file:///usr/local/lib/python3.5/dist-packages/keras/layers/core.py">
+    <entry file="file://$PROJECT_DIR$/yolo3/utils.py">
       <provider selected="true" editor-type-id="text-editor">
-        <state relative-caret-position="195">
-          <caret line="600" column="8" lean-forward="false" selection-start-line="600" selection-start-column="8" selection-end-line="600" selection-end-column="8" />
+        <state relative-caret-position="18">
+          <caret line="131" column="24" lean-forward="false" selection-start-line="131" selection-start-column="24" selection-end-line="131" selection-end-column="24" />
           <folding />
         </state>
       </provider>
     </entry>
     <entry file="file://$PROJECT_DIR$/yolo3/model.py">
       <provider selected="true" editor-type-id="text-editor">
-        <state relative-caret-position="195">
-          <caret line="415" column="4" lean-forward="false" selection-start-line="415" selection-start-column="4" selection-end-line="415" selection-end-column="4" />
+        <state relative-caret-position="-399">
+          <caret line="127" column="4" lean-forward="false" selection-start-line="127" selection-start-column="4" selection-end-line="127" selection-end-column="4" />
           <folding>
             <element signature="e#77#104#0" expanded="true" />
           </folding>
         </state>
       </provider>
     </entry>
-    <entry file="file://$PROJECT_DIR$/train.py">
+    <entry file="file://$PROJECT_DIR$/dornet_utils.py">
       <provider selected="true" editor-type-id="text-editor">
-        <state relative-caret-position="-399">
-          <caret line="143" column="24" lean-forward="false" selection-start-line="143" selection-start-column="24" selection-end-line="143" selection-end-column="24" />
-          <folding />
+        <state relative-caret-position="113">
+          <caret line="422" column="10" lean-forward="false" selection-start-line="422" selection-start-column="10" selection-end-line="422" selection-end-column="10" />
+          <folding>
+            <element signature="e#38#47#0" expanded="true" />
+          </folding>
         </state>
       </provider>
     </entry>
     <entry file="file://$PROJECT_DIR$/train_decision.py">
       <provider selected="true" editor-type-id="text-editor">
-        <state relative-caret-position="195">
-          <caret line="246" column="4" lean-forward="false" selection-start-line="246" selection-start-column="4" selection-end-line="246" selection-end-column="4" />
+        <state relative-caret-position="267">
+          <caret line="58" column="43" lean-forward="false" selection-start-line="58" selection-start-column="43" selection-end-line="58" selection-end-column="43" />
           <folding>
             <element signature="e#92#101#0" expanded="true" />
           </folding>
         </state>
       </provider>
     </entry>
+    <entry file="file://$PROJECT_DIR$/darknet_flags.py">
+      <provider selected="true" editor-type-id="text-editor">
+        <state relative-caret-position="213">
+          <caret line="20" column="40" lean-forward="false" selection-start-line="20" selection-start-column="40" selection-end-line="20" selection-end-column="40" />
+          <folding />
+        </state>
+      </provider>
+    </entry>
   </component>
 </project>
\ No newline at end of file
diff --git a/darknet_flags.py b/darknet_flags.py
index 26bd6af..f25bda0 100644
--- a/darknet_flags.py
+++ b/darknet_flags.py
@@ -15,13 +15,13 @@ gflags.DEFINE_string('img_mode', "rgb", 'Load mode for images, either '
                      'rgb or grayscale')
 
 # Training
-gflags.DEFINE_integer('batch_size', 8, 'Batch size in training and evaluation')
+gflags.DEFINE_integer('batch_size', 64, 'Batch size in training and evaluation')
 gflags.DEFINE_integer('epochs', 50, 'Number of epochs for training')
-gflags.DEFINE_integer('log_rate', 10, 'Logging rate for full model (epochs)')
-gflags.DEFINE_integer('initial_epoch', 0, 'Initial epoch to start training')
+gflags.DEFINE_integer('log_rate', 5, 'Logging rate for full model (epochs)')
+gflags.DEFINE_integer('initial_epoch', 6, 'Initial epoch to start training')
 
 # Files
-gflags.DEFINE_string('experiment_rootdir', "/home/zq610/WYZ/deeplearning/network/rpg_public_dronet/darknet14", 'Folder '
+gflags.DEFINE_string('experiment_rootdir', "/home/zq610/WYZ/deeplearning/network/keras-yolo3/logs/detection_decision", 'Folder '
                      ' containing all the logs, model weights and results')
 gflags.DEFINE_string('train_dir', "/media/zq610/2C9BDE0469DC4DFC/ubuntu/dl_dataset/Dornet/training", 'Folder containing'
                      ' training experiments')
@@ -29,13 +29,13 @@ gflags.DEFINE_string('val_dir', "/media/zq610/2C9BDE0469DC4DFC/ubuntu/dl_dataset
                      ' validation experiments')
 gflags.DEFINE_string('test_dir', "/media/zq610/2C9BDE0469DC4DFC/ubuntu/dl_dataset/Dornet/testing", 'Folder containing'
                      ' testing experiments')
-gflags.DEFINE_string('log_dir', "/home/zq610/WYZ/deeplearning/network/rpg_public_dronet/logs/darknet", 'Folder containing'
+gflags.DEFINE_string('log_dir', "/home/zq610/WYZ/deeplearning/network/keras-yolo3/logs/detection_decision", 'Folder containing'
                      ' training logs')
 
 # Model
-gflags.DEFINE_bool('restore_model', False, 'Whether to restore a trained'
+gflags.DEFINE_bool('restore_model', True, 'Whether to restore a trained'
                    ' model for training')
-gflags.DEFINE_string('weights_fname', "model_weights.h5", '(Relative) '
+gflags.DEFINE_string('weights_fname', "/home/zq610/WYZ/deeplearning/network/keras-yolo3/logs/detection_decision2/ep006-loss4.120-val_loss4.098.h5", '(Relative) '
                                           'filename of model weights')
 gflags.DEFINE_string('json_model_fname', "model_struct.json",
                           'Model struct json serialization, filename')
diff --git a/dornet_utils.py b/dornet_utils.py
index 42fa5de..807fcfc 100644
--- a/dornet_utils.py
+++ b/dornet_utils.py
@@ -351,10 +351,12 @@ def hard_mining_mse(k):
             true_steer = y_true[:,1]
 
             # Steering loss
+            # 平方差误差
             l_steer = tf.multiply(t, K.square(pred_steer - true_steer))
 
             # Hard mining
             k_min = tf.minimum(k, n_samples_steer)
+            # 选取k_min个最大的误差
             _, indices = tf.nn.top_k(l_steer, k=k_min)
             max_l_steer = tf.gather(l_steer, indices)
             hard_l_steer = tf.divide(tf.reduce_sum(max_l_steer), tf.cast(k,tf.float32))
diff --git a/run_this.sh b/run_this.sh
index 181b0a8..120de72 100755
--- a/run_this.sh
+++ b/run_this.sh
@@ -24,5 +24,5 @@
 
 
 # test the model trained from keras-yolo, using the video
-python yolo_video.py --model logs/trained_weights_final.h5 --anchors turtlebot_training/anchor.txt --classes turtlebot_training/classes.txt --gpu_num 1 --input /media/zq610/2C9BDE0469DC4DFC/ubuntu/dl_dataset/turtlebot/raw_videos/two_small_1.mp4
+#python yolo_video.py --model logs/trained_weights_final.h5 --anchors turtlebot_training/anchor.txt --classes turtlebot_training/classes.txt --gpu_num 1 --input /media/zq610/2C9BDE0469DC4DFC/ubuntu/dl_dataset/turtlebot/raw_videos/two_small_1.mp4
 
diff --git a/train_decision.py b/train_decision.py
index 02a5e8e..2d348f1 100644
--- a/train_decision.py
+++ b/train_decision.py
@@ -19,6 +19,7 @@ import dornet_utils
 from darknet_flags import FLAGS
 import tensorflow as tf
 from yolo3 import utils
+import dronet_log_utils
 
 
 def _main(argv):
@@ -49,10 +50,18 @@ def _main(argv):
 
     input_shape = (320, 320) # multiple of 32, hw
 
+    initial_epoch = 0
+    if not FLAGS.restore_model:
+        # In this case weights will start from random
+        weights_path = None
+    else:
+        weights_path = FLAGS.weights_fname
+        initial_epoch = FLAGS.initial_epoch
+
     is_tiny_version = len(anchors) == 6 # default setting
     if is_tiny_version:
         model = create_tiny_model(input_shape, anchors, num_classes, dronet_trainable_layer, \
-            freeze_body=2, weights_path=tiny_yolo_weights_path, )
+            freeze_body=2, yolo_weights_path=tiny_yolo_weights_path, weights_path=weights_path)
     else:
         model = create_model(input_shape, anchors, num_classes,
             freeze_body=2, weights_path=yolo_weights_path) # make sure you know what you freeze
@@ -62,9 +71,9 @@ def _main(argv):
     checkpoint = ModelCheckpoint(log_dir + 'ep{epoch:03d}-loss{loss:.3f}-val_loss{val_loss:.3f}.h5',
         monitor='val_loss', save_weights_only=True, save_best_only=True, period=3)
     # 当评价指标不在提升时，减少学习率
-    # reduce_lr = ReduceLROnPlateau(monitor='val_loss', factor=0.1, patience=3, verbose=1)
+    reduce_lr = ReduceLROnPlateau(monitor='val_loss', factor=0.1, patience=3, verbose=1)
     # 当监测值不再改善时，该回调函数将中止训练
-    # early_stopping = EarlyStopping(monitor='val_loss', min_delta=0, patience=10, verbose=1)
+    early_stopping = EarlyStopping(monitor='val_loss', min_delta=0, patience=10, verbose=1)
 
     val_split = 0.1
     # 读取dataset，并打乱顺序
@@ -102,6 +111,8 @@ def _main(argv):
     model.k_mse = tf.Variable(batch_size, trainable=False, name='k_mse', dtype=tf.int32)
     model.k_entropy = tf.Variable(batch_size, trainable=False, name='k_entropy', dtype=tf.int32)
 
+    # json_model_path = os.path.join(FLAGS.experiment_rootdir, FLAGS.json_model_fname)
+    # dornet_utils.modelToJson(model, json_model_path)
 
     # Train with frozen layers first, to get a stable loss.
     # Adjust num epochs to your dataset. This step is enough to obtain a not bad model.
@@ -114,6 +125,11 @@ def _main(argv):
                             'activation_2': dornet_utils.hard_mining_entropy(model.k_entropy)},
                     optimizer=Adam(lr=1e-3), loss_weights=[0, model.alpha, model.beta])
 
+        dronet_log_utils.configure_output_dir(FLAGS.experiment_rootdir)
+        saveModelAndLoss = dronet_log_utils.MyCallback(filepath=FLAGS.experiment_rootdir,
+                                                period=FLAGS.log_rate,
+                                                batch_size=FLAGS.batch_size)
+
         print('Train on {} samples, val on {} samples, with batch size {}.'
               .format(dronet_train_dataset.samples, dronet_val_dataset.samples, batch_size))
         steps_per_epoch = int(np.ceil(dronet_train_dataset.samples / batch_size))
@@ -123,11 +139,11 @@ def _main(argv):
         model.fit_generator(data_generator_wrapper(dronet_train_dataset, lines[:num_train],
                                                    batch_size, input_shape, anchors, num_classes),
                             epochs=FLAGS.epochs, steps_per_epoch=steps_per_epoch,
-                            callbacks=[logging, checkpoint],
+                            callbacks=[saveModelAndLoss, logging, checkpoint, reduce_lr, early_stopping],
                             validation_data=data_generator_wrapper(dronet_val_dataset,
                                             lines[num_train:], batch_size, input_shape, anchors, num_classes),
                             validation_steps=validation_steps,
-                            initial_epoch=0, )
+                            initial_epoch=initial_epoch, )
 
         model.save_weights(log_dir + 'trained_weights_stage_1.h5')
 
@@ -199,8 +215,8 @@ def create_model(input_shape, anchors, num_classes, load_pretrained=True, freeze
 
     return model
 
-def create_tiny_model(input_shape, anchors, num_classes, dronet_trainable_layer, load_pretrained=True,
-                      freeze_body=2, weights_path='model_data/tiny_yolo_weights.h5'):
+def create_tiny_model(input_shape, anchors, num_classes, dronet_trainable_layer, weights_path,
+                      load_pretrained=True, freeze_body=2, yolo_weights_path='model_data/tiny_yolo_weights.h5', ):
     '''create the training model, for Tiny YOLOv3'''
     K.clear_session() # get a new session
     h, w = input_shape
@@ -224,11 +240,16 @@ def create_tiny_model(input_shape, anchors, num_classes, dronet_trainable_layer,
     print('Create Tiny YOLOv3 model with {} anchors and {} classes.'.format(num_anchors, num_classes))
 
     if load_pretrained:
-        # by_name=True意味着通过layer的名字进行读取
-        # by_name=False意味着通过网络结构进行读取
-        # 这里应该是因为所有的layer都是默认的名字，所以，直接对应就好
-        model_body.load_weights(weights_path, by_name=True, skip_mismatch=True)
-        print('Load weights {}.'.format(weights_path))
+        if not weights_path:
+            # by_name=True意味着通过layer的名字进行读取
+            # by_name=False意味着通过网络结构进行读取
+            # 这里应该是因为所有的layer都是默认的名字，所以，直接对应就好
+            model_body.load_weights(yolo_weights_path, by_name=True, skip_mismatch=True)
+            print('Load weights {}.'.format(yolo_weights_path))
+        else:
+            model_body.load_weights(weights_path, by_name=True, skip_mismatch=True)
+            print("Loaded model from {}".format(weights_path))
+
         freeze_layer = list(range(len(model_body.layers)))
         freeze_layer = list(set(freeze_layer).difference(dronet_trainable_layer))
         try:
